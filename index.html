<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Nobet">
    <meta name="theme-color" content="#ffffff">
    <title>Nobet Takip</title>
    <link rel="manifest" href="./manifest.json">
    <link rel="apple-touch-icon" href="./icon-192.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #ffffff;
            color: #1a1a2e;
            min-height: 100vh;
            min-height: 100dvh;
            overflow-x: hidden;
        }

        .app-header {
            background: #ffffff;
            border-bottom: 1px solid #e8e8e8;
            padding: 16px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .app-header h1 {
            font-size: 20px;
            font-weight: 700;
            color: #1a1a2e;
            text-align: center;
        }

        .app-header .subtitle {
            font-size: 13px;
            color: #7f8c9b;
            text-align: center;
            margin-top: 2px;
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 12px;
        }

        .step-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #e0e0e0;
            transition: all 0.3s ease;
        }

        .step-dot.active {
            background: #2a9d8f;
            width: 28px;
            border-radius: 5px;
        }

        .step-dot.done {
            background: #2a9d8f;
        }

        .screen {
            display: none;
            padding: 20px;
            padding-bottom: 100px;
            animation: fadeIn 0.3s ease;
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Month Selector */
        .month-selector {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            margin-bottom: 24px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 12px;
        }

        .month-selector button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: #ffffff;
            color: #2a9d8f;
            font-size: 20px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: all 0.2s;
        }

        .month-selector button:active {
            transform: scale(0.92);
            background: #f0f0f0;
        }

        .month-selector .month-label {
            font-size: 18px;
            font-weight: 600;
            color: #1a1a2e;
            min-width: 160px;
            text-align: center;
        }

        /* Section Titles */
        .section-title {
            font-size: 15px;
            font-weight: 600;
            color: #7f8c9b;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Nurse Cards */
        .nurse-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }

        .nurse-card {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 14px 16px;
            background: #ffffff;
            border: 2px solid #e8e8e8;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
            -webkit-user-select: none;
        }

        .nurse-card:active {
            transform: scale(0.98);
        }

        .nurse-card.selected {
            border-color: #2a9d8f;
            background: #f0faf8;
        }

        .nurse-card .nurse-avatar {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: #e8e8e8;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: 700;
            color: #7f8c9b;
            flex-shrink: 0;
            transition: all 0.2s;
        }

        .nurse-card.selected .nurse-avatar {
            background: #2a9d8f;
            color: #ffffff;
        }

        .nurse-card .nurse-name {
            font-size: 16px;
            font-weight: 500;
            color: #1a1a2e;
            flex: 1;
        }

        .nurse-card .check-icon {
            width: 26px;
            height: 26px;
            border-radius: 50%;
            border: 2px solid #d0d0d0;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.2s;
        }

        .nurse-card.selected .check-icon {
            background: #2a9d8f;
            border-color: #2a9d8f;
        }

        .nurse-card.selected .check-icon::after {
            content: '';
            width: 6px;
            height: 11px;
            border: solid #ffffff;
            border-width: 0 2.5px 2.5px 0;
            transform: rotate(45deg) translateY(-1px);
        }

        .selected-count {
            text-align: center;
            font-size: 14px;
            color: #7f8c9b;
            margin-top: 16px;
            margin-bottom: 8px;
        }

        .selected-count strong {
            color: #2a9d8f;
        }

        /* Bottom Action Bar */
        .bottom-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 16px 20px;
            padding-bottom: max(16px, env(safe-area-inset-bottom));
            background: #ffffff;
            border-top: 1px solid #e8e8e8;
            z-index: 100;
        }

        .btn-primary {
            width: 100%;
            padding: 16px;
            background: #2a9d8f;
            color: #ffffff;
            border: none;
            border-radius: 12px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary:active {
            transform: scale(0.98);
            background: #238b7e;
        }

        .btn-primary:disabled {
            background: #c8d6d3;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            width: 100%;
            padding: 14px;
            background: #f8f9fa;
            color: #1a1a2e;
            border: 2px solid #e8e8e8;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-secondary:active {
            transform: scale(0.98);
            background: #f0f0f0;
        }

        .bottom-bar .btn-row {
            display: flex;
            gap: 10px;
        }

        .bottom-bar .btn-row .btn-secondary {
            flex: 1;
        }

        .bottom-bar .btn-row .btn-primary {
            flex: 2;
        }

        /* Screen 2: Shift Entry */
        .shift-nurse-card {
            background: #ffffff;
            border: 1px solid #e8e8e8;
            border-radius: 14px;
            margin-bottom: 16px;
            overflow: hidden;
            box-shadow: 0 1px 4px rgba(0,0,0,0.04);
        }

        .shift-nurse-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px;
            background: #f8f9fa;
            border-bottom: 1px solid #e8e8e8;
            cursor: pointer;
        }

        .shift-nurse-header .nurse-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .shift-nurse-header .nurse-info .avatar-sm {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #2a9d8f;
            color: #ffffff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 700;
        }

        .shift-nurse-header .nurse-info .name {
            font-size: 16px;
            font-weight: 600;
            color: #1a1a2e;
        }

        .shift-count-badge {
            background: #2a9d8f;
            color: #ffffff;
            font-size: 12px;
            font-weight: 700;
            padding: 4px 10px;
            border-radius: 20px;
            min-width: 28px;
            text-align: center;
        }

        .shift-count-badge.empty {
            background: #e0e0e0;
            color: #7f8c9b;
        }

        .shift-nurse-body {
            padding: 12px 16px 16px;
        }

        .shift-entry {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
            flex-wrap: wrap;
        }

        .shift-entry:last-of-type {
            border-bottom: none;
        }

        .shift-field {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .shift-field label {
            font-size: 11px;
            font-weight: 600;
            color: #7f8c9b;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .shift-field input {
            width: 72px;
            height: 44px;
            border: 2px solid #e8e8e8;
            border-radius: 10px;
            text-align: center;
            font-size: 17px;
            font-weight: 600;
            color: #1a1a2e;
            background: #ffffff;
            outline: none;
            transition: border-color 0.2s;
            -webkit-appearance: none;
        }

        .shift-field input:focus {
            border-color: #2a9d8f;
        }

        .shift-type-toggle {
            display: flex;
            border-radius: 10px;
            overflow: hidden;
            border: 2px solid #e8e8e8;
            height: 44px;
        }

        .shift-type-btn {
            padding: 0 14px;
            border: none;
            background: #ffffff;
            font-size: 14px;
            font-weight: 600;
            color: #7f8c9b;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .shift-type-btn.active-day {
            background: #fff3e0;
            color: #e67e22;
        }

        .shift-type-btn.active-night {
            background: #e8eaf6;
            color: #3949ab;
        }

        .btn-delete-shift {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background: #fff5f5;
            color: #e74c3c;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            margin-left: auto;
            transition: all 0.2s;
        }

        .btn-delete-shift:active {
            background: #fee;
            transform: scale(0.9);
        }

        .btn-add-shift {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            width: 100%;
            padding: 12px;
            margin-top: 8px;
            border: 2px dashed #d0d0d0;
            border-radius: 10px;
            background: transparent;
            color: #2a9d8f;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-add-shift:active {
            background: #f0faf8;
            border-color: #2a9d8f;
        }

        .empty-shifts-msg {
            text-align: center;
            padding: 16px;
            color: #b0b0b0;
            font-size: 14px;
        }

        /* Screen 3: Summary */
        .summary-card {
            background: #ffffff;
            border: 1px solid #e8e8e8;
            border-radius: 14px;
            margin-bottom: 16px;
            overflow: hidden;
            box-shadow: 0 1px 4px rgba(0,0,0,0.04);
        }

        .summary-card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            background: #f8f9fa;
            border-bottom: 1px solid #e8e8e8;
        }

        .summary-card-header .avatar-sm {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #2a9d8f;
            color: #ffffff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 700;
        }

        .summary-card-header .name {
            font-size: 16px;
            font-weight: 600;
            color: #1a1a2e;
        }

        .summary-table {
            width: 100%;
            border-collapse: collapse;
        }

        .summary-table th {
            padding: 10px 16px;
            font-size: 12px;
            font-weight: 700;
            color: #7f8c9b;
            text-align: left;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            border-bottom: 1px solid #f0f0f0;
        }

        .summary-table td {
            padding: 10px 16px;
            font-size: 15px;
            color: #1a1a2e;
            border-bottom: 1px solid #f0f0f0;
        }

        .summary-table tr:last-child td {
            border-bottom: none;
        }

        .type-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
        }

        .type-badge.day {
            background: #fff3e0;
            color: #e67e22;
        }

        .type-badge.night {
            background: #e8eaf6;
            color: #3949ab;
        }

        .summary-totals {
            display: flex;
            gap: 0;
            border-top: 2px solid #e8e8e8;
        }

        .summary-total-item {
            flex: 1;
            padding: 14px;
            text-align: center;
            border-right: 1px solid #e8e8e8;
        }

        .summary-total-item:last-child {
            border-right: none;
        }

        .summary-total-item .total-label {
            font-size: 11px;
            font-weight: 700;
            color: #7f8c9b;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .summary-total-item .total-value {
            font-size: 22px;
            font-weight: 700;
            margin-top: 4px;
        }

        .summary-total-item .total-value.day-color {
            color: #e67e22;
        }

        .summary-total-item .total-value.night-color {
            color: #3949ab;
        }

        .summary-total-item .total-value.total-color {
            color: #2a9d8f;
        }

        .summary-total-item .total-unit {
            font-size: 12px;
            color: #7f8c9b;
            font-weight: 500;
        }

        /* Grand Total */
        .grand-total-card {
            background: linear-gradient(135deg, #2a9d8f 0%, #238b7e 100%);
            border-radius: 14px;
            padding: 20px;
            margin-bottom: 24px;
            color: #ffffff;
        }

        .grand-total-card h3 {
            font-size: 14px;
            font-weight: 600;
            opacity: 0.85;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .grand-total-row {
            display: flex;
            gap: 0;
        }

        .grand-total-item {
            flex: 1;
            text-align: center;
        }

        .grand-total-item .g-value {
            font-size: 28px;
            font-weight: 800;
        }

        .grand-total-item .g-label {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 2px;
        }

        /* Responsive: Landscape / Tablet */
        @media (min-width: 480px) {
            .nurse-grid {
                grid-template-columns: 1fr 1fr;
            }

            .shift-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 16px;
            }

            .summary-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 16px;
            }

            .grand-total-card {
                max-width: 500px;
                margin-left: auto;
                margin-right: auto;
            }
        }

        @media (min-width: 768px) {
            .nurse-grid {
                grid-template-columns: 1fr 1fr 1fr;
            }

            .screen {
                max-width: 900px;
                margin: 0 auto;
            }

            .shift-entry {
                flex-wrap: nowrap;
            }
        }

        /* Select All / Deselect All */
        .selection-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 16px;
        }

        .btn-select-action {
            flex: 1;
            padding: 10px;
            border: 2px solid #e8e8e8;
            border-radius: 10px;
            background: #ffffff;
            font-size: 14px;
            font-weight: 600;
            color: #7f8c9b;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-select-action:active {
            background: #f0f0f0;
            transform: scale(0.97);
        }

        /* No shifts warning */
        .warning-msg {
            background: #fff9e6;
            border: 1px solid #ffd54f;
            border-radius: 10px;
            padding: 12px 16px;
            margin-bottom: 16px;
            font-size: 14px;
            color: #856404;
            text-align: center;
        }

        /* New Month Reset Button */
        .reset-section {
            margin-top: 40px;
            padding-top: 24px;
            border-top: 1px dashed #e0e0e0;
            text-align: center;
        }

        .btn-reset {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 10px 20px;
            background: #ffffff;
            color: #c0392b;
            border: 1.5px solid #e8c8c5;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-reset:active {
            background: #fdf2f2;
            transform: scale(0.97);
        }

        /* Modal Overlay */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.4);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-overlay.visible {
            display: flex;
        }

        .modal-card {
            background: #ffffff;
            border-radius: 16px;
            padding: 28px 24px;
            max-width: 340px;
            width: 100%;
            text-align: center;
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
            animation: modalIn 0.25s ease;
        }

        @keyframes modalIn {
            from { opacity: 0; transform: scale(0.92); }
            to { opacity: 1; transform: scale(1); }
        }

        .modal-card .modal-icon {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: #fdf2f2;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 16px;
            font-size: 22px;
        }

        .modal-card h3 {
            font-size: 18px;
            font-weight: 700;
            color: #1a1a2e;
            margin-bottom: 8px;
        }

        .modal-card p {
            font-size: 14px;
            color: #7f8c9b;
            line-height: 1.5;
            margin-bottom: 24px;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
        }

        .modal-actions .btn-modal-cancel {
            flex: 1;
            padding: 14px;
            background: #f8f9fa;
            border: 2px solid #e8e8e8;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            color: #1a1a2e;
            cursor: pointer;
            transition: all 0.2s;
        }

        .modal-actions .btn-modal-cancel:active {
            background: #f0f0f0;
            transform: scale(0.97);
        }

        .modal-actions .btn-modal-confirm {
            flex: 1;
            padding: 14px;
            background: #c0392b;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            color: #ffffff;
            cursor: pointer;
            transition: all 0.2s;
        }

        .modal-actions .btn-modal-confirm:active {
            background: #a93226;
            transform: scale(0.97);
        }

        /* Month Picker Modal */
        .month-picker-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
            margin-bottom: 20px;
        }

        .month-picker-btn {
            padding: 12px 8px;
            border: 2px solid #e8e8e8;
            border-radius: 10px;
            background: #ffffff;
            font-size: 14px;
            font-weight: 600;
            color: #1a1a2e;
            cursor: pointer;
            transition: all 0.2s;
        }

        .month-picker-btn:active {
            transform: scale(0.95);
        }

        .month-picker-btn.selected {
            background: #2a9d8f;
            color: #ffffff;
            border-color: #2a9d8f;
        }

        .year-selector {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            margin-bottom: 16px;
        }

        .year-selector button {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 2px solid #e8e8e8;
            background: #ffffff;
            color: #2a9d8f;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .year-selector button:active {
            transform: scale(0.9);
            background: #f0f0f0;
        }

        .year-selector .year-label {
            font-size: 20px;
            font-weight: 700;
            color: #1a1a2e;
            min-width: 60px;
            text-align: center;
        }

        .month-picker-card {
            background: #ffffff;
            border-radius: 16px;
            padding: 28px 24px;
            max-width: 360px;
            width: 100%;
            text-align: center;
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
            animation: modalIn 0.25s ease;
        }

        .month-picker-card h3 {
            font-size: 18px;
            font-weight: 700;
            color: #1a1a2e;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>

<header class="app-header">
    <h1>Nobet Takip</h1>
    <div class="subtitle" id="headerSubtitle">Hemşire Seçimi</div>
    <div class="step-indicator">
        <div class="step-dot active" id="dot1"></div>
        <div class="step-dot" id="dot2"></div>
        <div class="step-dot" id="dot3"></div>
    </div>
</header>

<!-- SCREEN 1: Nurse Selection -->
<div class="screen active" id="screen1">
    <div class="month-selector" style="pointer-events:none;">
        <div class="month-label" id="monthLabel"></div>
    </div>

    <div class="section-title">Nobet Tutan Hemşireler</div>

    <div class="selection-actions">
        <button class="btn-select-action" id="selectAll">Tümünü Seç</button>
        <button class="btn-select-action" id="deselectAll">Tümünü Kaldır</button>
    </div>

    <div class="nurse-grid" id="nurseGrid"></div>

    <div class="selected-count" id="selectedCount"></div>

    <div class="reset-section">
        <button class="btn-reset" id="btnResetMonth">Yeni Ay Girişi Yap</button>
    </div>
</div>

<!-- SCREEN 2: Shift Entry -->
<div class="screen" id="screen2">
    <div class="month-selector" style="pointer-events:none; opacity: 0.7;">
        <div class="month-label" id="monthLabel2"></div>
    </div>
    <div class="section-title">Nobet Bilgilerini Girin</div>
    <div id="shiftContainer" class="shift-grid"></div>
</div>

<!-- SCREEN 3: Summary -->
<div class="screen" id="screen3">
    <div class="month-selector" style="pointer-events:none; opacity: 0.7;">
        <div class="month-label" id="monthLabel3"></div>
    </div>

    <div class="grand-total-card" id="grandTotalCard">
        <h3>Genel Toplam</h3>
        <div class="grand-total-row">
            <div class="grand-total-item">
                <div class="g-value" id="gtDay">0</div>
                <div class="g-label">Gündüz Saat</div>
            </div>
            <div class="grand-total-item">
                <div class="g-value" id="gtNight">0</div>
                <div class="g-label">Gece Saat</div>
            </div>
            <div class="grand-total-item">
                <div class="g-value" id="gtTotal">0</div>
                <div class="g-label">Toplam Saat</div>
            </div>
        </div>
    </div>

    <div class="section-title">Hemşire Detayları</div>
    <div id="summaryContainer" class="summary-grid"></div>
</div>

<!-- Bottom Bar -->
<div class="bottom-bar" id="bottomBar">
    <button class="btn-primary" id="btnNext">Devam Et</button>
</div>

<!-- Reset Confirmation Modal -->
<div class="modal-overlay" id="resetModal">
    <div class="modal-card">
        <div class="modal-icon">&#9888;</div>
        <h3>Emin misiniz?</h3>
        <p>Mevcut aydaki tüm nöbet bilgileri silinecek ve yeni ay için temiz bir sayfa açılacak.</p>
        <div class="modal-actions">
            <button class="btn-modal-cancel" id="modalCancel">Vazgeç</button>
            <button class="btn-modal-confirm" id="modalConfirm">Evet, Sıfırla</button>
        </div>
    </div>
</div>

<!-- Month Picker Modal -->
<div class="modal-overlay" id="monthPickerModal">
    <div class="month-picker-card">
        <h3>Ay Seçin</h3>
        <div class="year-selector">
            <button id="pickerPrevYear">&lsaquo;</button>
            <div class="year-label" id="pickerYearLabel"></div>
            <button id="pickerNextYear">&rsaquo;</button>
        </div>
        <div class="month-picker-grid" id="monthPickerGrid"></div>
    </div>
</div>

<script>
    // ==================== DATA ====================
    const ALL_NURSES = [
        'Fatma Keleş', 'Tuğçe Baştürk', 'Meral Tanyeli', 'Ulviye Çaylak',
        'Ayşe Ünal Söylemez', 'Filiz Çetinkaya', 'Nilüfer Karakoç', 'Ayşe Ayazlı',
        'Şeniz Çelik', 'Seher Beğce', 'Semre Elbeyi', 'Burcu Mardin',
        'Dilara Gürdal', 'Gül Görhan', 'Muharrem Özden', 'Kürşat Solak'
    ];

    const MONTHS_TR = [
        'Ocak', 'Şubat', 'Mart', 'Nisan', 'Mayıs', 'Haziran',
        'Temmuz', 'Ağustos', 'Eylül', 'Ekim', 'Kasım', 'Aralık'
    ];

    let currentScreen = 1;
    let selectedMonth = new Date().getMonth();
    let selectedYear = new Date().getFullYear();
    let selectedNurses = new Set(ALL_NURSES);
    let shiftData = {}; // { "Nurse Name": [ { day, hours, type } ] }
    let pickerYear = new Date().getFullYear();
    let monthPickerCallback = null; // called after month is picked

    // ==================== INIT ====================
    function init() {
        setupEventListeners();

        // Check if there's existing data for current month
        const hasData = localStorage.getItem(getStorageKey());
        if (hasData) {
            loadFromStorage();
            renderNurseGrid();
            updateMonthLabel();
            updateSelectedCount();
        } else {
            // First time or no data: ask for month
            showMonthPicker(function(month, year) {
                selectedMonth = month;
                selectedYear = year;
                loadFromStorage();
                renderNurseGrid();
                updateMonthLabel();
                updateSelectedCount();
            });
        }
    }

    // ==================== STORAGE ====================
    function getStorageKey() {
        return `nobet_${selectedYear}_${selectedMonth}`;
    }

    function saveToStorage() {
        const data = {
            selectedNurses: [...selectedNurses],
            shiftData: shiftData
        };
        localStorage.setItem(getStorageKey(), JSON.stringify(data));
    }

    function loadFromStorage() {
        const saved = localStorage.getItem(getStorageKey());
        if (saved) {
            try {
                const data = JSON.parse(saved);
                selectedNurses = new Set(data.selectedNurses || ALL_NURSES);
                shiftData = data.shiftData || {};
            } catch (e) {
                selectedNurses = new Set(ALL_NURSES);
                shiftData = {};
            }
        } else {
            selectedNurses = new Set(ALL_NURSES);
            shiftData = {};
        }
    }

    // ==================== MONTH LABEL ====================
    function updateMonthLabel() {
        const label = `${MONTHS_TR[selectedMonth]} ${selectedYear}`;
        document.getElementById('monthLabel').textContent = label;
        document.getElementById('monthLabel2').textContent = label;
        document.getElementById('monthLabel3').textContent = label;
    }

    // ==================== MONTH PICKER ====================
    function showMonthPicker(callback) {
        monthPickerCallback = callback;
        pickerYear = new Date().getFullYear();
        renderMonthPicker();
        document.getElementById('monthPickerModal').classList.add('visible');
    }

    function hideMonthPicker() {
        document.getElementById('monthPickerModal').classList.remove('visible');
        monthPickerCallback = null;
    }

    function renderMonthPicker() {
        document.getElementById('pickerYearLabel').textContent = pickerYear;
        const grid = document.getElementById('monthPickerGrid');
        grid.innerHTML = '';
        MONTHS_TR.forEach((name, idx) => {
            const btn = document.createElement('button');
            btn.className = 'month-picker-btn';
            btn.textContent = name;
            btn.addEventListener('click', () => {
                if (monthPickerCallback) {
                    monthPickerCallback(idx, pickerYear);
                }
                hideMonthPicker();
            });
            grid.appendChild(btn);
        });
    }

    // ==================== RESET / NEW MONTH ====================
    function showResetModal() {
        document.getElementById('resetModal').classList.add('visible');
    }

    function hideResetModal() {
        document.getElementById('resetModal').classList.remove('visible');
    }

    function resetForNewMonth() {
        // Clear current data from storage
        localStorage.removeItem(getStorageKey());
        hideResetModal();

        // Show month picker for new month
        showMonthPicker(function(month, year) {
            selectedMonth = month;
            selectedYear = year;

            // Reset in-memory data
            selectedNurses = new Set(ALL_NURSES);
            shiftData = {};

            // Update UI
            updateMonthLabel();
            renderNurseGrid();
            updateSelectedCount();
            goToScreen(1);
        });
    }

    // ==================== SCREEN 1: NURSE SELECTION ====================
    function getInitials(name) {
        const parts = name.split(' ');
        if (parts.length >= 2) {
            return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
        }
        return name.substring(0, 2).toUpperCase();
    }

    function renderNurseGrid() {
        const grid = document.getElementById('nurseGrid');
        grid.innerHTML = '';

        ALL_NURSES.forEach(name => {
            const card = document.createElement('div');
            card.className = 'nurse-card' + (selectedNurses.has(name) ? ' selected' : '');
            card.innerHTML = `
                <div class="nurse-avatar">${getInitials(name)}</div>
                <div class="nurse-name">${name}</div>
                <div class="check-icon"></div>
            `;
            card.addEventListener('click', () => {
                if (selectedNurses.has(name)) {
                    selectedNurses.delete(name);
                } else {
                    selectedNurses.add(name);
                }
                card.classList.toggle('selected');
                card.querySelector('.nurse-avatar').style.transition = 'all 0.2s';
                updateSelectedCount();
                saveToStorage();
            });
            grid.appendChild(card);
        });
    }

    function updateSelectedCount() {
        const count = selectedNurses.size;
        document.getElementById('selectedCount').innerHTML =
            `<strong>${count}</strong> / ${ALL_NURSES.length} hemşire seçili`;

        const btn = document.getElementById('btnNext');
        if (currentScreen === 1) {
            btn.disabled = count === 0;
        }
    }

    // ==================== SCREEN 2: SHIFT ENTRY ====================
    function renderShiftEntry() {
        const container = document.getElementById('shiftContainer');
        container.innerHTML = '';

        const activeNurses = ALL_NURSES.filter(n => selectedNurses.has(n));

        activeNurses.forEach(name => {
            if (!shiftData[name]) {
                shiftData[name] = [];
            }

            const card = document.createElement('div');
            card.className = 'shift-nurse-card';

            const shiftCount = shiftData[name].length;

            card.innerHTML = `
                <div class="shift-nurse-header">
                    <div class="nurse-info">
                        <div class="avatar-sm">${getInitials(name)}</div>
                        <div class="name">${name}</div>
                    </div>
                    <div class="shift-count-badge ${shiftCount === 0 ? 'empty' : ''}">${shiftCount}</div>
                </div>
                <div class="shift-nurse-body" data-nurse="${name}">
                    ${shiftCount === 0 ? '<div class="empty-shifts-msg">Henüz nöbet eklenmedi</div>' : ''}
                </div>
            `;

            container.appendChild(card);

            const body = card.querySelector('.shift-nurse-body');

            // Render existing shifts
            shiftData[name].forEach((shift, idx) => {
                body.appendChild(createShiftRow(name, idx, shift));
            });

            // Add shift button
            const addBtn = document.createElement('button');
            addBtn.className = 'btn-add-shift';
            addBtn.innerHTML = '<span style="font-size:20px">+</span> Nöbet Ekle';
            addBtn.addEventListener('click', () => {
                shiftData[name].push({ day: '', hours: '', type: 'gunduz' });
                // Remove empty message if exists
                const emptyMsg = body.querySelector('.empty-shifts-msg');
                if (emptyMsg) emptyMsg.remove();

                const newIdx = shiftData[name].length - 1;
                body.insertBefore(createShiftRow(name, newIdx, shiftData[name][newIdx]), addBtn);
                updateShiftBadge(card, name);
                saveToStorage();
            });
            body.appendChild(addBtn);
        });
    }

    function createShiftRow(nurseName, index, shift) {
        const row = document.createElement('div');
        row.className = 'shift-entry';
        row.dataset.index = index;

        row.innerHTML = `
            <div class="shift-field">
                <label>Gün</label>
                <input type="number" inputmode="numeric" min="1" max="31"
                       placeholder="1-31" value="${shift.day || ''}"
                       data-field="day">
            </div>
            <div class="shift-field">
                <label>Saat</label>
                <input type="number" inputmode="numeric" min="1" max="24"
                       placeholder="Saat" value="${shift.hours || ''}"
                       data-field="hours">
            </div>
            <div class="shift-field">
                <label>Tip</label>
                <div class="shift-type-toggle">
                    <button class="shift-type-btn ${shift.type === 'gunduz' ? 'active-day' : ''}"
                            data-type="gunduz">Gündüz</button>
                    <button class="shift-type-btn ${shift.type === 'gece' ? 'active-night' : ''}"
                            data-type="gece">Gece</button>
                </div>
            </div>
            <button class="btn-delete-shift" title="Sil">&times;</button>
        `;

        // Input events
        row.querySelectorAll('input').forEach(input => {
            input.addEventListener('change', () => {
                const field = input.dataset.field;
                let val = parseInt(input.value);
                if (field === 'day' && val > 31) val = 31;
                if (field === 'day' && val < 1) val = 1;
                if (field === 'hours' && val > 24) val = 24;
                if (field === 'hours' && val < 1) val = 1;
                if (!isNaN(val)) {
                    input.value = val;
                    shiftData[nurseName][index][field] = val;
                } else {
                    shiftData[nurseName][index][field] = '';
                }
                saveToStorage();
            });
        });

        // Type toggle
        row.querySelectorAll('.shift-type-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                row.querySelector('.active-day')?.classList.remove('active-day');
                row.querySelector('.active-night')?.classList.remove('active-night');
                const type = btn.dataset.type;
                btn.classList.add(type === 'gunduz' ? 'active-day' : 'active-night');
                shiftData[nurseName][index].type = type;
                saveToStorage();
            });
        });

        // Delete
        row.querySelector('.btn-delete-shift').addEventListener('click', () => {
            shiftData[nurseName].splice(index, 1);
            // Re-render this nurse's shifts
            const card = row.closest('.shift-nurse-card');
            const body = card.querySelector('.shift-nurse-body');
            const addBtn = body.querySelector('.btn-add-shift');

            // Remove all shift rows
            body.querySelectorAll('.shift-entry').forEach(r => r.remove());
            body.querySelector('.empty-shifts-msg')?.remove();

            if (shiftData[nurseName].length === 0) {
                const emptyMsg = document.createElement('div');
                emptyMsg.className = 'empty-shifts-msg';
                emptyMsg.textContent = 'Henüz nöbet eklenmedi';
                body.insertBefore(emptyMsg, addBtn);
            } else {
                shiftData[nurseName].forEach((s, i) => {
                    body.insertBefore(createShiftRow(nurseName, i, s), addBtn);
                });
            }
            updateShiftBadge(card, nurseName);
            saveToStorage();
        });

        return row;
    }

    function updateShiftBadge(card, nurseName) {
        const badge = card.querySelector('.shift-count-badge');
        const count = shiftData[nurseName].length;
        badge.textContent = count;
        badge.className = 'shift-count-badge' + (count === 0 ? ' empty' : '');
    }

    // ==================== SCREEN 3: SUMMARY ====================
    function renderSummary() {
        const container = document.getElementById('summaryContainer');
        container.innerHTML = '';

        const activeNurses = ALL_NURSES.filter(n => selectedNurses.has(n));

        let grandDayTotal = 0;
        let grandNightTotal = 0;

        activeNurses.forEach(name => {
            const shifts = (shiftData[name] || []).filter(s => s.day && s.hours);

            if (shifts.length === 0) return;

            // Sort by day
            shifts.sort((a, b) => a.day - b.day);

            let dayTotal = 0;
            let nightTotal = 0;

            shifts.forEach(s => {
                const h = parseFloat(s.hours) || 0;
                if (s.type === 'gunduz') dayTotal += h;
                else nightTotal += h;
            });

            grandDayTotal += dayTotal;
            grandNightTotal += nightTotal;

            const card = document.createElement('div');
            card.className = 'summary-card';

            let tableRows = '';
            shifts.forEach(s => {
                const typeClass = s.type === 'gunduz' ? 'day' : 'night';
                const typeLabel = s.type === 'gunduz' ? 'Gündüz' : 'Gece';
                tableRows += `
                    <tr>
                        <td>${s.day}. gün</td>
                        <td>${s.hours} saat</td>
                        <td><span class="type-badge ${typeClass}">${typeLabel}</span></td>
                    </tr>
                `;
            });

            card.innerHTML = `
                <div class="summary-card-header">
                    <div class="avatar-sm">${getInitials(name)}</div>
                    <div class="name">${name}</div>
                </div>
                <table class="summary-table">
                    <thead>
                        <tr>
                            <th>Tarih</th>
                            <th>Süre</th>
                            <th>Tip</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${tableRows}
                    </tbody>
                </table>
                <div class="summary-totals">
                    <div class="summary-total-item">
                        <div class="total-label">Gündüz</div>
                        <div class="total-value day-color">${dayTotal}</div>
                        <div class="total-unit">saat</div>
                    </div>
                    <div class="summary-total-item">
                        <div class="total-label">Gece</div>
                        <div class="total-value night-color">${nightTotal}</div>
                        <div class="total-unit">saat</div>
                    </div>
                    <div class="summary-total-item">
                        <div class="total-label">Toplam</div>
                        <div class="total-value total-color">${dayTotal + nightTotal}</div>
                        <div class="total-unit">saat</div>
                    </div>
                </div>
            `;

            container.appendChild(card);
        });

        // Grand total
        document.getElementById('gtDay').textContent = grandDayTotal;
        document.getElementById('gtNight').textContent = grandNightTotal;
        document.getElementById('gtTotal').textContent = grandDayTotal + grandNightTotal;
    }

    // ==================== NAVIGATION ====================
    function goToScreen(num) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(`screen${num}`).classList.add('active');
        currentScreen = num;

        // Step dots
        for (let i = 1; i <= 3; i++) {
            const dot = document.getElementById(`dot${i}`);
            dot.className = 'step-dot';
            if (i < num) dot.classList.add('done');
            if (i === num) dot.classList.add('active');
        }

        // Subtitle
        const titles = { 1: 'Hemşire Seçimi', 2: 'Nöbet Girişi', 3: 'Özet' };
        document.getElementById('headerSubtitle').textContent = titles[num];

        // Bottom bar
        updateBottomBar();

        // Scroll to top
        window.scrollTo(0, 0);
    }

    function updateBottomBar() {
        const bar = document.getElementById('bottomBar');

        if (currentScreen === 1) {
            bar.innerHTML = `<button class="btn-primary" id="btnNext" ${selectedNurses.size === 0 ? 'disabled' : ''}>Devam Et</button>`;
            bar.querySelector('#btnNext').addEventListener('click', () => {
                saveToStorage();
                renderShiftEntry();
                goToScreen(2);
            });
        } else if (currentScreen === 2) {
            bar.innerHTML = `
                <div class="btn-row">
                    <button class="btn-secondary" id="btnBack">Geri</button>
                    <button class="btn-primary" id="btnNext">Özeti Göster</button>
                </div>
            `;
            bar.querySelector('#btnBack').addEventListener('click', () => {
                saveToStorage();
                goToScreen(1);
            });
            bar.querySelector('#btnNext').addEventListener('click', () => {
                saveToStorage();
                renderSummary();
                goToScreen(3);
            });
        } else if (currentScreen === 3) {
            bar.innerHTML = `<button class="btn-secondary" id="btnBack" style="width:100%">Geri Dön</button>`;
            bar.querySelector('#btnBack').addEventListener('click', () => {
                goToScreen(2);
            });
        }
    }

    // ==================== EVENT LISTENERS ====================
    function setupEventListeners() {
        document.getElementById('selectAll').addEventListener('click', () => {
            selectedNurses = new Set(ALL_NURSES);
            renderNurseGrid();
            updateSelectedCount();
            saveToStorage();
        });

        document.getElementById('deselectAll').addEventListener('click', () => {
            selectedNurses.clear();
            renderNurseGrid();
            updateSelectedCount();
            saveToStorage();
        });

        // Reset month button & modal
        document.getElementById('btnResetMonth').addEventListener('click', showResetModal);
        document.getElementById('modalCancel').addEventListener('click', hideResetModal);
        document.getElementById('modalConfirm').addEventListener('click', resetForNewMonth);

        // Close modal on overlay click
        document.getElementById('resetModal').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) hideResetModal();
        });

        // Month picker year navigation
        document.getElementById('pickerPrevYear').addEventListener('click', () => {
            pickerYear--;
            renderMonthPicker();
        });
        document.getElementById('pickerNextYear').addEventListener('click', () => {
            pickerYear++;
            renderMonthPicker();
        });

        // Initial bottom bar
        updateBottomBar();
    }

    // ==================== SERVICE WORKER ====================
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./sw.js').catch(() => {});
    }

    // ==================== START ====================
    init();
</script>

</body>
</html>
